FROM ubuntu:24.04
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update -qq && \
    apt-get install -y -qq bash curl git xz-utils ca-certificates sudo \
        python3 python3-pip python3-venv build-essential && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install devbox as root
RUN curl -fsSL https://get.jetify.com/devbox | FORCE=1 bash

# Core global packages
RUN devbox global add claude-code go nodejs uv

# TDD-guard tools and beads
SHELL ["/bin/bash", "-c"]
RUN eval "$(devbox global shellenv --preserve-path-stack -r)" && \
    go install github.com/nizos/tdd-guard/reporters/go/cmd/tdd-guard-go@latest && \
    go install github.com/steveyegge/beads/cmd/bd@latest && \
    npm install -g tdd-guard tdd-guard-vitest && \
    pip3 install --break-system-packages tdd-guard-pytest

# Pre-cache devbox shellenv
RUN devbox global shellenv > /etc/devbox_shellenv && chmod 644 /etc/devbox_shellenv

# Create non-root user with same UID as typical macOS user
RUN useradd -m -s /bin/bash -u 501 claude 2>/dev/null || \
    useradd -m -s /bin/bash claude && \
    echo "claude ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Fix permissions for non-root access to nix/devbox
RUN chmod 755 /root && \
    chmod -R o+rX /root/.local /root/.nix-profile 2>/dev/null || true && \
    chmod -R o+rx /root/go 2>/dev/null || true

ENV PATH="/root/go/bin:/usr/local/bin:$PATH"

# Switch to non-root user
USER claude
ENV HOME=/home/claude

# entrypoint.sh is mounted at runtime via -v, not baked into image
CMD ["/bin/bash"]
